<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="shortcut icon" href="/img/logo_refhouse%20(5).png" />
    <!-- Подключаем Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        .image-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* Определяем автоматический размер столбцов */
            grid-gap: 10px; /* Расстояние между изображениями */
        }

        .image-block img {
            max-height: 100px;
            width: auto;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <form id="projectForm" th:method="POST" th:action="@{/updateProject/{id}(id=${project.getId()})}" th:object="${project}" method="post" enctype="multipart/form-data">
        <div class="form-group">
            <label for="projectName">Название проекта:</label>
            <input type="text" th:field="*{projectName}" class="form-control" id="projectName" required/>
            <small class="text-danger" th:if="${#fields.hasErrors('projectName')}" th:errors="*{projectName}">Error</small>
        </div>
        <div class="form-group">
            <label for="projectPrice">Стоимость проекта текст:</label>
            <input type="text" th:field="*{projectPrice}" class="form-control" id="projectPrice" required/>
            <small class="text-danger" th:if="${#fields.hasErrors('projectPrice')}" th:errors="*{projectPrice}">Error</small>
        </div>
        <div class="form-group">
            <label for="projectPriceNum">Стоимость проекта цифры:</label>
            <input type="text" th:field="*{projectPriceNum}" class="form-control" id="projectPriceNum" required/>
            <small class="text-danger" th:if="${#fields.hasErrors('projectPriceNum')}" th:errors="*{projectPriceNum}">Error</small>
        </div>
        <div class="form-group">
            <label for="projectInfo">Описание проекта:</label>
            <textarea th:field="*{projectInfo}" class="form-control" id="projectInfo" rows="4" required></textarea>
            <small class="text-danger" th:if="${#fields.hasErrors('projectInfo')}" th:errors="*{projectInfo}">Error</small>
        </div>
        <div class="mb-3">
            <label for="projectImages" class="form-label">Изображения проекта:</label>
            <div id="addedImages" class="image-container">
<!--                <div th:each="image, imaIndex : ${project.images}">-->
<!--                    <div class="image-block mb-3">-->
<!--                        <img th:src="@{'/getProjectImage/' + ${image.id}}"-->
<!--                             th:attr="data-img-context=${image.imgContextName}, data-img-info=${image.ingInfo}"-->
<!--                             class="d-block w-100 img-fluid"-->
<!--                             th:alt="${' Изображение ' + (imaIndex.index + 1)}">-->
<!--                        <input type="checkbox" th:checked="${image.isTitle}" />-->
<!--                    </div>-->
<!--                </div>-->
            </div>
            <input type="file" name="projectImages" id="projectImages" class="form-control" accept="image/*" multiple/>
        </div>
        <button type="submit" class="btn btn-primary">Изменить проект</button>
    </form>

    <form method="post" th:method="DELETE" th:action="@{/deleteProject/{id}(id=${project.getId()})}" style="display:inline;">
        <button type="submit" class="btn btn-danger">Удалить проект</button>
    </form>
    <div class="col-md-6">
        <a th:href="@{/Admin.html}" class="btn btn-warning mt-3">Выход</a>
    </div>
</div>

<!-- Подключаем Bootstrap JS и Popper.js -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initImages();
    });

    function initImages() {
        // Здесь добавь код для инициализации изображений, которые уже есть в проекте
        const existingImages = [
            // Предполагается, что этот массив будет заполнен данными с сервера
            // Например, так: [{ id: 1, src: '/getProjectImage/1', isTitle: true }, {...}]
        ];

        existingImages.forEach((img, index) => {
            addImageBlock(img.src, index, img.isTitle);
        });
    }
</script>
<script>
    let filesArray = [];
    let titleImages = [];

    document.getElementById('projectImages').addEventListener('change', function(event) {
        const files = Array.from(event.target.files);

        files.forEach((file, index) => {
            filesArray.push(file);
            const imageURL = URL.createObjectURL(file);
            addImageBlock(imageURL, filesArray.length - 1); // Передаем индекс из filesArray
        });

        event.target.value = ''; // Очистить input для предотвращения повторного выбора тех же файлов
    });


    fetch('/getJsonArray/1', {
        method: 'GET'
        // body: formData
    })
        .then(response => {
            console.log('Response status:', response.status);
            return response.text(); // Изменим на text(), чтобы видеть исходный ответ сервера
        })
        .then(data => {
            console.log('Response data:', data);
            // try {
            //     const jsonData = JSON.parse(data);
            //     console.log('Success:', jsonData);
            //     if (jsonData.status === 'success') {
            //         window.location.href = '/main/Admin';
            //     }
            // } catch (error) {
            //     console.error('Parsing error:', error);
            //     // Добавь обработку ошибки
            // }
        })
        .catch((error) => {
            console.error('Error:', error);
            // Добавь обработку ошибки
        });

    function addImageBlock(imageURL, index, isTitle = false) {
        const imageBlock = document.createElement('div');
        imageBlock.className = 'mb-3 image-block';

        const image = document.createElement('img');
        image.src = imageURL;

        const deleteButton = document.createElement('button');
        deleteButton.type = 'button';
        deleteButton.className = 'btn btn-danger';
        deleteButton.innerText = 'Удалить';
        deleteButton.onclick = function() {
            imageBlock.remove();
            filesArray.splice(index, 1); // Обрати внимание, что это может быть некорректно для уже существующих изображений
            titleImages = titleImages.filter(i => i !== index);
        };

        const titleCheckbox = document.createElement('input');
        titleCheckbox.type = 'checkbox';
        titleCheckbox.name = 'isTitle';
        titleCheckbox.value = 'true';
        titleCheckbox.checked = isTitle;
        titleCheckbox.onchange = function() {
            if (this.checked) {
                titleImages.push(index);
            } else {
                titleImages = titleImages.filter(i => i !== index);
            }
        };

        const checkboxLabel = document.createElement('label');
        checkboxLabel.innerText = ' Set as title image';
        checkboxLabel.prepend(titleCheckbox);

        imageBlock.appendChild(image);
        imageBlock.appendChild(checkboxLabel);
        imageBlock.appendChild(deleteButton);

        document.getElementById('addedImages').appendChild(imageBlock);
    }

    document.getElementById('projectForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const formData = new FormData();

        // Добавить текстовые поля формы
        formData.append('projectName', document.getElementById('projectName').value);
        formData.append('projectPrice', document.getElementById('projectPrice').value);
        formData.append('projectPriceNum', document.getElementById('projectPriceNum').value);
        formData.append('projectInfo', document.getElementById('projectInfo').value);

        // Добавить файлы из массива filesArray
        filesArray.forEach((file, index) => {
            formData.append('projectImages', file);
            formData.append('isTitle', titleImages.includes(index));
        });

    });
</script>
</body>
</html>
