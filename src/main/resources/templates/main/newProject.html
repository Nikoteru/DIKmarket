<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Project</title>
    <link rel="shortcut icon" href="/img/logo_refhouse%20(5).png" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .image-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* Определяем автоматический размер столбцов */
            grid-gap: 10px; /* Расстояние между изображениями */
        }

        .image-block img {
            max-height: 100px;
            width: auto;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mt-5">New Project</h1>
    <form id="projectForm" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="projectName" class="form-label">Название проекта:</label>
            <input type="text" name="projectName" id="projectName" class="form-control" required/>
        </div>
        <div class="mb-3">
            <label for="projectPrice" class="form-label">Стоимость проекта текст:</label>
            <input type="text" name="projectPrice" id="projectPrice" class="form-control"/>
        </div>
        <div class="mb-3">
            <label for="projectPriceNum" class="form-label">Стоимость проекта цифра:</label>
            <input type="number" name="projectPriceNum" id="projectPriceNum" class="form-control"/>
        </div>
        <div class="mb-3">
            <label for="projectInfo" class="form-label">Описание проекта:</label>
            <textarea name="projectInfo" id="projectInfo" class="form-control" rows="5" required></textarea>
        </div>
        <div class="mb-3">
            <label for="projectImages" class="form-label">Изображения проекта:</label>
            <div id="addedImages" class="image-container"></div>
            <input type="file" name="projectImages" id="projectImages" class="form-control" accept="image/*" multiple/>
        </div>
        <button type="submit" class="btn btn-primary">Сохранить проект</button>
    </form>
    <hr/>
    <a href="/Admin.html" class="btn btn-secondary">Назад</a>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let filesArray = [];
    let titleImages = [];

    document.getElementById('projectImages').addEventListener('change', function(event) {
        const files = Array.from(event.target.files);

        files.forEach((file, index) => {
            filesArray.push(file);
            const imageURL = URL.createObjectURL(file);
            addImageBlock(imageURL, filesArray.length - 1); // Передаем индекс из filesArray
        });

        event.target.value = ''; // Очистить input для предотвращения повторного выбора тех же файлов
    });

    function addImageBlock(imageURL, index) {
        const imageBlock = document.createElement('div');
        imageBlock.className = 'mb-3 image-block';

        const image = document.createElement('img');
        image.src = imageURL;

        const deleteButton = document.createElement('button');
        deleteButton.type = 'button';
        deleteButton.className = 'btn btn-danger';
        deleteButton.innerText = 'Удалить';
        deleteButton.onclick = function() {
            imageBlock.remove();
            filesArray.splice(index, 1);
            titleImages = titleImages.filter(i => i !== index);
        };

        const titleCheckbox = document.createElement('input');
        titleCheckbox.type = 'checkbox';
        titleCheckbox.name = 'isTitle';
        titleCheckbox.value = 'true';
        titleCheckbox.onchange = function() {
            if (this.checked) {
                titleImages.push(index);
            } else {
                titleImages = titleImages.filter(i => i !== index);
            }
        };

        const checkboxLabel = document.createElement('label');
        checkboxLabel.innerText = ' Set as title image';
        checkboxLabel.prepend(titleCheckbox);

        imageBlock.appendChild(image);
        imageBlock.appendChild(checkboxLabel);
        imageBlock.appendChild(deleteButton);

        document.getElementById('addedImages').appendChild(imageBlock);
    }

    document.getElementById('projectForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const formData = new FormData();

        // Добавить текстовые поля формы
        formData.append('projectName', document.getElementById('projectName').value);
        formData.append('projectPrice', document.getElementById('projectPrice').value);
        formData.append('projectPriceNum', document.getElementById('projectPriceNum').value);
        formData.append('projectInfo', document.getElementById('projectInfo').value);

        // Добавить файлы из массива filesArray
        filesArray.forEach((file, index) => {
            formData.append('projectImages', file);
            formData.append('isTitle', titleImages.includes(index));
        });

        fetch('/newProject', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                console.log('Response status:', response.status);
                return response.text(); // Изменим на text(), чтобы видеть исходный ответ сервера
            })
            .then(data => {
                console.log('Response data:', data);
                try {
                    const jsonData = JSON.parse(data);
                    console.log('Success:', jsonData);
                    if (jsonData.status === 'success') {
                        window.location.href = '/Admin.html';
                    }
                } catch (error) {
                    console.error('Parsing error:', error);
                    // Добавь обработку ошибки
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                // Добавь обработку ошибки
            });
    });
</script>
</body>
</html>
